Vagrant.configure("2") do |config|
  nodes = [
    { name: "manager", ip: "192.168.56.100" },
    { name: "worker1", ip: "192.168.56.101" },
    { name: "worker2", ip: "192.168.56.102" }
  ]

  nodes.each do |node|
    config.vm.define node[:name] do |node_config|
      node_config.vm.box = "bento/ubuntu-20.04"
      node_config.vm.provider "vmware_workstation"
      node_config.vm.network "private_network", ip: node[:ip]
      node_config.vm.provision "shell", inline: <<-SHELL
        apt-get update && apt-get install -y docker.io
        usermod -aG docker vagrant
        curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
      SHELL
    end
  end

  config.vm.define "manager" do |manager_config|
    manager_config.vm.provision "shell", inline: <<-SHELL
      docker swarm init --advertise-addr 192.168.56.100
      docker swarm join-token worker -q > /vagrant/worker_token
    SHELL
  end

  nodes.drop(1).each do |worker|
    config.vm.define worker[:name] do |worker_config|
      worker_config.vm.provision "shell", inline: <<-SHELL
        docker swarm join --token $(cat /vagrant/worker_token) 192.168.56.100:2377
      SHELL
    end
  end

  config.vm.define "manager" do |manager_config|
    manager_config.vm.provision "shell", inline: <<-SHELL
      sleep 10  # Attendre que les workers rejoignent
      docker network create --driver overlay app-net
      docker stack deploy -c /vagrant/docker-compose.yml app
    SHELL
  end
end